# JVM

---

## 类加载

---

### Java 默认的三个类加载器

**BootStrap ClassLoader：**

称为启动类加载器，是 Java 类加载层次中最顶层的类加载器， 负责加载 JDK 中的核心类库，

如：rt.jar、resources.jar、charsets.jar 等，

**Extension ClassLoader：**

称为扩展类加载器，负责加载 Java 的扩展类库，Java 虚拟机的实现会提供一个扩展库目录。

该类加载器在此目录里面查找并加载 Java 类。默认加载 JAVA_HOME/jre/lib/ext/ 目下的所有 jar。

**App ClassLoader：**

称为系统类加载器，负责加载应用程序 classpath 目录下的所有 jar 和 class 文件。一般来说，Java 应用的类都是由它来完成加载的。

可以通过 ClassLoader.getSystemClassLoader() 来获取它。

其他加载器：自定义加载器，必须继承 ClassLoader。

### 类加载

JVM 虚拟机执行 class 字节码的过程可以分为七个阶段：加载、验证、准备、解析、初始化、使用、卸载。

1、找到 .class 文件并把这个文件包含的字节码加载到内存中。

2、分三步，字节码验证；class 类数据结构分析及相应的内存分配；最后的符号表的链接。

验证与分析：

    字节码验证，类装入器对于类的字节码要做很多检测，以确保格式正确，行为正确。

    类装备，准备代表每个类中定义的字段、方法和实现接口所必须的数据结构。

    解析，装入器装入类所引用的其他所有类。

3、类中静态属性和初始化赋值，以及静态块的执行等。

### 类的初始化步骤

如果这个类还没有被加载和链接，那先进行加载和链接；

假如这个类存在直接父类，并且这个类还没有被初始化 (注意：在一个类加载器中，类只能初始化一次)，那就初始化直接的父类 (不适用于接口)；

加入类中存在初始化语句 (如 static 变量和 static 块)，那就依次执行这些初始化语句。

### 双亲委派机制

**工作过程：**

如果一个类加载器收到了类加载的请求，它首先不会自己去尝试加载这个类，而是把这个请求委派给父类加载器去完成，

每一个层次的类加载器都是如此，因此所有的加载请求最终都应该传送到最顶层的启动类加载器中，

只有当父加载器反馈自己无法完成这个加载请求（它的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去完成加载。

**作用：**

1、Java 中的类随着它的类加载器一起，具备了一种带有优先级的层次关系。

2、防止重复加载同一个.class。通过委托去向上面问一问，加载过了，就不用再加载一遍。保证数据安全。

3、保证核心.class 不能被篡改。

    通过委托方式，不会去篡改核心.class，即使篡改也不会去加载，即使加载也不会是同一个.class 对象了。
    不同的加载器加载同一个.class 也不是同一个 Class 对象。这样保证了 Class 执行安全。

---

参考链接：

- [详细深入分析 Java ClassLoader 工作机制](https://segmentfault.com/a/1190000008491597)
- [jvm 类加载器，类加载机制详解，看这一篇就够了](https://segmentfault.com/a/1190000037574626)
- []()
- []()
- []()
