# Concurrent

---

## 基础部分

---

### 线程安全

线程安全问题的原因

常用方案

### 多线程，要求输出 AAB、 BAA、 ABA

### CAS

---

## 锁

---

### 锁的使用

分布式锁

同步锁

### 什么是死锁

指多个进程在运行过程中因争夺资源而造成的一种僵局，当进程处于这种僵持状态时，若无外力作用，它们都将无法再向前推进。

### 死锁的原因

死锁产生的原因主要包括：

> 系统资源不足；
>
> 程序执行的顺序有问题；
>
> 资源分配不当等。

如果系统资源充足，进程的资源请求都能够得到满足，那么死锁出现的可能性就很低；否则，

就会因争夺有限的资源而陷入死锁。其次，程序执行的顺序与速度不同，也可能产生死锁。

### 死锁的四个必要条件

> **互斥**：一个资源每次只能被一个线程使用。
>
> **请求与保持**：一个线程因请求资源而阻塞时，对已获得的资源保持不放。
>
> **不剥夺**：线程已获得的资源，在未使用完之前，不能强行剥夺。
>
> **循环等待**：若干线程之间形成一种头尾相接的循环等待资源关系。

分析：

> 互斥条件 ---> 独占锁的特点之一。
>
> 请求与保持条件 ---> 独占锁的特点之一，尝试获取锁时并不会释放已经持有的锁
>
> 不剥夺条件 ---> 独占锁的特点之一。
>
> **循环等待条件** ---> **唯一需要记忆的造成死锁的条件**。

### 如何避免死锁

1、以确定的顺序获得锁：

如果必须获取多个锁，那么在设计的时候需要充分考虑不同线程之前获得锁的顺序。

针对两个特定的锁，开发者可以尝试按照锁对象的 hashCode 值大小的顺序，分别获得两个锁，这样锁总是会以特定的顺序获得锁，那么死锁也不会发生。

问题变得更加复杂一些，如果此时有多个线程，都在竞争不同的锁，简单按照锁对象的 hashCode 进行排序（单纯按照 hashCode 顺序排序会出现
“环路等待”），可能就无法满足要求了，这个时候开发者可以使用银行家算法，所有的锁都按照特定的顺序获取，同样可以防止死锁的发。

2、超时放弃：

当使用 synchronized 关键词提供的内置锁时，只要线程没有获得锁，那么就会永远等待下去，然而 Lock 接口提供了 boolean tryLock (long time, TimeUnit
unit) throws InterruptedException
方法，该方法可以按照固定时长等待锁，因此线程可以在获取锁超时以后，主动释放之前已经获得的所有的锁。通过这种方式，也可以很有效地避免死锁。

3、银行家算法：

银行家算法：首先需要定义状态和安全状态的概念。系统的状态是当前给进程分配的资源情况。

因此，状态包含两个向量 Resource（系统中每种资源的总量）和 Available（未分配给进程的每种资源的总量）及两个矩阵 Claim（表示进程对资源的需求）和
Allocation（表示当前分配给进程的资源）。

安全状态是指至少有一个资源分配序列不会导致死锁。

当进程请求一组资源时，假设同意该请求，从而改变了系统的状态，然后确定其结果是否还处于安全状态。

如果是，同意这个请求；如果不是，阻塞该进程知道同意该请求后系统状态仍然是安全的。

### 死锁的解决方式

如果利用死锁检测算法检测出系统已经出现了死锁 ，那么，此时就需要对系统采取相应的措施。

常用的解除死锁的方法：

> 1、抢占资源：从一个或多个进程中抢占足够数量的资源分配给死锁进程，以解除死锁状态。
>
> 2、终止（或撤销）进程：终止或撤销系统中的一个或多个死锁进程，直至打破死锁状态。
>
> > a、终止所有的死锁进程。这种方式简单粗暴，但是代价很大，很有可能会导致一些已经运行了很久的进程前功尽弃。
> >
> > b、逐个终止进程，直至死锁状态解除。该方法的代价也很大，因为每终止一个进程就需要使用死锁检测来检测系统当前是否处于死锁状态。另外，每次终止进程的时候终止那个进程呢？每次都应该采用最优策略来选择一个 “代价最小” 的进程来解除死锁状态。
> >
> > 一般根据如下几个方面来决定终止哪个进程：
> >
> > > 进程的优先级
> > >
> > > 进程已运行时间以及运行完成还需要的时间
> > >
> > > 进程已占用系统资源
> > >
> > > 进程运行完成还需要的资源
> > >
> > > 终止进程数目
> > >
> > > 进程是交互还是批处理

---

## 提高部分

---

###

---







---

参考链接：

- [什么是死锁，产生死锁的原因及必要条件](https://blog.csdn.net/hd12370/article/details/82814348)
- [死锁的四个必要条件和解决办法](https://blog.csdn.net/guaiguaihenguai/article/details/80303835)
- []()

---



