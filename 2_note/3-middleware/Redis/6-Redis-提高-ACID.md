# Redis

---

## Redis ACID

---

### Redis 的 ACID 属性

**Atomicity / 原子性**：

Redis 不支持回滚。

Redis 命令在事务执行时可能会失败，但仍会继续执行剩余命令而不是 Rollback（事务回滚）。

如果你使用过关系数据库，这种情况可能会让你感到很奇怪。

来自官网的解释：

- Redis 作者认为发生事务回滚的原因大部分都是程序错误导致，这种情况一般发生在开发和测试阶段，而生产环境很少出现。
- 对于逻辑性错误，比如本来应该把一个数加 1 ，但是程序逻辑写成了加 2，那么这种错误也是无法通过事务回滚来进行解决的。
- Redis 追求的是简单高效，而传统事务的实现相对比较复杂，这和 Redis 的设计思想相违背。

**Consistency / 一致性**：

一致性是事务执行前后的数据符合数据库的定义和要求。

这一点 Redis 中的事务是符合要求的，不论是发生语法错误还是运行时错误，错误的命令均不会被执行。

**Isolation / 隔离性**：

事务中的所有命令都会按顺序执行。

在执行 Redis 事务的过程中，另一个客户端发出的请求不可能被服务，这保证了命令是作为单独的独立操作执行的。

所以 Redis 当中的事务是符合隔离性要求的。

**Durability / 持久性**：

- 如果 Redis 当中没有被开启持久化，那么就是纯内存运行的，一旦重启，所有数据都会丢失，此时可以认为 Redis 不具备事务的持久性；
- 而如果 Redis 开启了持久化，那么可以认为 Redis 在特定条件下是具备持久性的。

---

## Redis 持久性

---

### Redis 如何实现数据不丢失（重要）

Redis 数据是存储在内存中的，为了保证 Redis 数据不丢失，那就要把数据从内存存储到磁盘上，以便在服务器重启后还能够从磁盘中恢复原有数据，这就是 Redis 的数据持久化。

Redis 数据持久化有三种方式：

> AOF 日志（Append Only File，文件追加方式）：记录所有的操作命令，并以文本的形式追加到文件中。
>
> RDB 快照（Redis DataBase）：将某一个时刻的内存数据，以二进制的方式写入磁盘。
>
> 混合持久化方式：Redis 6.0 新增了混合持久化的方式，集成了 RDB 和 AOF 的优点。

### AOF 和 RDB 的实现原理（重要）

**AOF**：

采用的是写后日志的方式，Redis 先执行命令把数据写入内存，然后再记录日志到文件中。

AOF 日志记录的是操作命令，不是实际的数据，如果采用 AOF 方法做故障恢复时需要将全量日志都执行一遍。

**RDB**：

采用的是内存快照的方式，它记录的是某一时刻的数据，而不是操作，所以采用 RDB 方法做故障恢复时只需要直接把 RDB 文件读入内存即可，实现快速恢复。





---

## Redis 持久性（补充）

---

### Redis 为什么要先执行命令，再把数据写入日志

主要是由于 Redis 在写入日志之前，不对命令进行语法检查，所以只记录执行成功的命令，避免出现记录错误命令的情况，

而且在命令执行后再写日志不会阻塞当前的写操作。

### 后写日志有什么风险

后写日志主要有两个风险可能会发生：

> 数据可能会丢失：如果 Redis 刚执行完命令，此时发生故障宕机，会导致这条命令存在丢失的风险。
>
> 可能阻塞其他操作：AOF 日志其实也是在主线程中执行，所以当 Redis 把日志文件写入磁盘的时候，还是会阻塞后续的操作无法执行。

### RDB 做快照时会阻塞线程吗

Redis 提供了两个命令来生成 RDB 快照文件，分别是 save 和 bgsave。

save 命令在主线程中执行，会导致阻塞。

而 bgsave 命令则会创建一个子进程，用于写入 RDB 文件的操作，避免了对主线程的阻塞，这也是 Redis RDB 的默认配置。

### RDB 做快照的时候数据能修改吗

save 是同步的会阻塞客户端命令，

bgsave 的时候是可以修改的。

### Redis 怎么解决在 bgsave 做快照的时候允许数据修改的

这里主要是利用 bgsave 的子线程实现的，具体操作如下：

> 如果主线程执行读操作，则主线程和 bgsave 子进程互相不影响；
>
> 如果主线程执行写操作，则被修改的数据会复制一份副本，然后 bgsave 子进程会把该副本数据写入 RDB 文件，在这个过程中，主线程仍然可以直接修改原来的数据。

要注意，Redis 对 RDB 的执行频率非常重要，因为这会影响快照数据的完整性以及 Redis 的稳定性，所以在 Redis 4.0 后，增加了 AOF 和 RDB 混合的数据持久化机制：

把数据以 RDB 的方式写入文件，再将后续的操作命令以 AOF 的格式存入文件，既保证了 Redis 重启速度，又降低数据丢失风险。








---

参考链接：

- [04 分布式一致性协议 Gossip 和 Redis 集群原理解析](https://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%9E%E8%B7%B5%E4%B9%8B%E8%B7%AF%EF%BC%88%E5%AE%8C%EF%BC%89/04%20%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%80%E8%87%B4%E6%80%A7%E5%8D%8F%E8%AE%AE%20Gossip%20%E5%92%8C%20Redis%20%E9%9B%86%E7%BE%A4%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90.md)
- []()
- []()
- []()

---


