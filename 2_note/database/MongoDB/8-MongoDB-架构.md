# MongoDB

---

## 模式

---

### MongoDB 架构模式

**Replica set / 复制集：**

复制集，mongodb 的架构方式之一 ，通常是三个对等的节点构成一个 “复制集” 集群，有 “primary” 和 secondary 等多中角色（稍后详细介绍），

其中 primary 负责读写请求，secondary 可以负责读请求，这有配置决定，其中 secondary 紧跟 primary 并应用 write 操作；

如果 primary 失效，则集群进行 “多数派” 选举，选举出新的 primary，即 failover 机制，即 HA 架构。

复制集解决了单点故障问题，也是 mongodb 垂直扩展的最小部署单位，当然 sharding cluster 中每个 shard 节点也可以使用 Replica set 提高数据可用性。

**Sharding cluster / 分片集群：**

分片集群，数据水平扩展的手段之一；

replica set 这种架构的缺点就是 “集群数据容量” 受限于单个节点的磁盘大小，如果数据量不断增加，对它进行扩容将时非常苦难的事情，

所以我们需要采用 Sharding 模式来解决这个问题。

将整个 collection 的数据将根据 sharding key 被 sharding 到多个 mongod 节点上，

即每个节点持有 collection 的一部分数据，这个集群持有全部数据，原则上 sharding 可以支撑数 TB 的数据。

### MongoDB 复制集群

MongoDB 高可用的基础是复制集群，复制集群本质来说就是一份数据存多份，保证一台机器挂掉了数据不会丢失。一个副本集至少有 3 个节点组成：

1、至少一个主节点（**Primary**）：负责整个集群的写操作入口，主节点挂掉之后会自动选出新的主节点。

2、一个或多个从节点（**Secondary**）：一般是 2 个或以上，从主节点同步数据，在主节点挂掉之后选举新节点。

3、零个或 1 个仲裁节点（**Arbiter**）：这个是为了节约资源或者多机房容灾用，只负责主节点选举时投票不存数据，保证能有节点获得多数赞成票。

从上面的节点类型可以看出，一个三节点的复制集群可能是 PSS 或者 PSA 结构。

PSA 结构优点是节约成本，但是缺点是 Primary 挂掉之后，一些依赖 majority（多数）特性的写功能出问题，因此一般不建议使用。

### MongoDB 的可扩展性 —— 分片集群

**分片集群架构：**

MongoDB 的分片集群由如下三个部分组成：

    Config：配置，本质上是一个 MongoDB 的副本集，负责存储集群的各种元数据和配置，如分片地址、chunks 等
    Mongos：路由服务，不存具体数据，从 Config 获取集群配置讲请求转发到特定的分片，并且整合分片结果返回给客户端。
    Mongod：一般将具体的单个分片叫 mongod，实质上每个分片都是一个单独的复制集群，具备负责集群的高可用特性。

**分片算法：**

MongoDB 支持两种分片算法来满足不同的查询需求：

    区间分片：可以按 shardkey 做区间查询的分片算法，直接按照 shardkey 的值来分片。
    hash 分片：用的最多的分片算法，按 shardkey 的 hash 值来分片。hash 分片可以看作一种特殊的区间分片。

### 读写策略

Write Concern —— 写策略

控制服务端一次写操作在什么情况下才返回客户端成功，由两个参数控制：

    w 参数：控制数据同步到多少个节点才算成功，取值范围 0～节点个数 /majority。0 表示服务端收到请求就返回成功，major 表示同步到大多数（大于等于 N/2）节点才返回成功。其它值表示具体的同步节点个数。默认为 1，表示 Primary 写成功就返回成功。
    j 参数：控制单个节点是否完成 oplog 持久化到磁盘才返回成功，取值范围 true/false。默认 false，因此可能最多丢 100ms 数据。

Read Concern —— 读策略

控制客户端从什么节点读取数据，默认为 primary，具体参数及含义：

    primary：读主节点
    primaryPreferred：优先读主节点，不存在时读从节点
    secondary：读从节点
    secondaryPreferred：优先读从节点，不存在时读主节点
    nearest：就近读，不区分主节点还是从节点，只考虑节点延时。

Read Concern Level —— 读级别

这是一个非常有意思的参数，也是最不容易理解的异常参数。

它主要控制的是读到的数据是不是最新的、是不是持久的，最新的和持久的是一对矛盾，最新的数据可能会被回滚，持久的数据可能不是最新的，这需要业务根据自己场景的容忍度做决策，前提是你的先知道有哪些，他们代表什么意义：

    local：直接从查询节点返回，不关心这些数据被同步到了多少个节点。存在被回滚的风险。
    available：适用于分片集群，和 local 差不多，也存在被回滚的风险。
    majority：返回被大多数节点确认过的数据，不会被回滚，前提是 WriteConcern=majority
    linearizable：适用于事务，读操作会等待在它开始前已经在执行的事务提交了才返回
    snapshot：适用于事务，快照隔离，直接从快照去。

---

