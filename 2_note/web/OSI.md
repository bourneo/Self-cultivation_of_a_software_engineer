# OSI

开放式系统互联模型 / Open System Interconnection Model

---

## 基础部分

---

### OSI 7 层模型

记忆口诀： **P**lease **D**o **N**ot **T**ake **S**ales **P**eople's **A**dvice

1. 物理层（Physical Layer）
    - 负责管理电脑通信设备和网络媒体之间的互通
    - 包括了针脚、电压、线缆规范、集线器、中继器、**网卡**、主机接口卡等
    - 例如：调制解调器、无线电、**光纤**

    - 物理层数据被称为**比特流（Bits）**
    - 主要作用：**比特流（二进制数据）的传输，将比特流转化为电流强弱传输，到达目的后再转化为比特流，即常说的数模转化和模数转换**


2. 数据链路层（Data Link Layer）
    - 负责网络寻址、错误侦测和改错
    - 当表头和表尾被加至数据包时，会形成信息框（DataFrame）
    - 数据链表头（DLH）是包含了物理地址和错误侦测及改错的方法
    - 数据链表尾（DLT）是一串指示数据包末端的字符串
    - 例如：**以太网**、**Wi-Fi（无线局域网）、GPRS（通用分组无线服务）、令牌环、HDLC、帧中继、ISDN、ATM、IEEE 802.11、FDDI、PPP

    - 分为两个子层：
        - 逻辑链路控制（logical link control，LLC）子层
        - 介质访问控制（Media access control，**MAC**）子层

    - 数据链路层时数据被称为**帧（Frames）**
    - 主要作用：**将比特流划分为具有意义的数据帧传送给对端**


3. 网络层（Network Layer）
    - 决定数据的路径选择和转寄，将网络表头（NH）加至数据包，以形成分组
    - 网络表头包含了网络资料
    - 例如：**IP（互联网协议）**、**ICMP**、**ARP**、RARP、IPX、BGP、OSPF、RIP、IGRP、EIGRP、X.25

    - 网络层数据被称做**包（Packages）**
    - 主要作用：**将网络地址转化为对应的物理地址**，并决定如何将数据从发送方路由到接收方


4. 传输层（Transport Layer）
    - 把传输表头（TH）加至资料以形成分组
    - 传输表头包含了所使用的协议等发送信息
    - 例如：**TCP（传输控制协议）**、**UDP**、RTP、SCTP、SPX、ATP、IL

    - 传输层数据被称作**段（Segments）**
    - 主要作用：主机间的数据传输，数据间的传输可以是不同网络，传输层解决了传输质量的问题


5. 会话层（Session Layer）
    - 负责在数据传输中设置和维护计算机网络中两台计算机之间的通信连接
    - 例如：**RPC**、ASAP、ISO 8327 / CCITT X.225、NetBIOS、Winsock、SOCKS、BSD sockets、PAP

    - 主要作用：**负责建立和断开通信连接**


6. 表示层（Presentation Layer）
    - 解决「不同系统之间通信语法问题」，在表示层数据将按照网络能理解的方案进行格式化，格式化因所使用网络的不同而不同
    - 例如：**ASCII**、TLS、XDR、ASN.1、NCP

    - 主要作用：**数据格式的转换**


7. 应用层（Application Layer）
    - 提供为应用软件而设计的接口，以设置与另一应用软件之间的通信
    - 例如：**HTTP**、HTTPS、SSH、FTP、Telnet、SMTP、SNMP、POP3、SIP、SSH、NFS、RTSP、XMPP、Whois、ENRP、TLS
    - 规定发送方和接收方必须使用一个固定长度的消息头，消息头必须使用某种固定的组成，消息头中必须记录消息体的长度等信息，方便接收方正确解析发送方发送的数据

### 网络设备-交换机

交换机可以接入多台电脑。

每个电脑网卡的 MAC 地址都是不一样的，电脑发送数据时，数据头部携带网卡的 MAC 地址，用 MAC 地址标识来不同的电脑。

交换机就可以识别数据头部的 MAC 地址来区分不同的电脑。

交换机除了能识别不同的电脑，还需要找到电脑连接的交换机端口，才能顺利的把数据从相应端口发送出去。

交换机通过自学机制，把学习到的设备 MAC 地址和交换机端口号添加到 MAC 地址表，并根据 MAC 地址表进行数据转发。

### 网络设备-路由器

- 交换机需要记录的 MAC 地址表也越来越多，需要的交换机也越来越多
- 但是交换机的容量和性能有限，MAC 地址表无法记录全世界电脑的 MAC 地址和对应的端口号，MAC 地址表太大也无法快速查找到对应的 MAC 地址表项

于是就有了三层网络设备路由器，路由器可以把全世界的网络连接起来：

1. 局域网内的网络连接可以使用交换机，例如一个公司内的网络或者一个校园内的网络通过交换机连接
2. 不同区域的局域网互联使用路由器

那么如何区分不同的网络区域呢？又是如何跨网络区域进行数据转发的呢？

1. 路由器有多个端口，分别连接不同的网络区域，不同网络区域的 IP 地址网络号不同
2. 它通过识别目的 IP 地址的网络号，再根据路由表进行数据转发

### MAC 地址

介质访问控制层（Media access control）：

MAC 称为物理地址，也叫硬件地址，用来定义网络设备的位置，MAC 地址是网卡出厂时设定的，是固定的。

（但可以通过在设备管理器中或注册表等方式修改，同一网段内的 MAC 地址必须唯一）。

MAC 地址采用十六进制数表示，长度是 6 个字节（48 位），分为前 24 位和后 24 位。

MAC 地址对应于 OSI 参考模型的第二层数据链路层，工作在数据链路层的交换机维护着计算机 MAC 地址和自身端口的数据库，交换机根据收到的数据帧中的目的 MAC 地址字段来转发数据帧。

### 子网掩码的概念及作用

1. 通过子网掩码，才能表明一台主机所在的子网与其他子网的关系，使网络正常工作
2. 子网掩码和 IP 地址做与运算，分离出 IP 地址中的网络地址和主机地址，用于判断该 IP 地址是在本地网络上，还是在远程网络网上
3. 子网掩码还用于将网络进一步划分为若干子网，以避免主机过多而拥堵或过少而 IP 浪费

### 子网掩码的组成

同 IP 地址一样，子网掩码是由长度为 32 位二进制数组成的一个地址。

子网掩码 32 位与 IP 地址 32 位相对应，IP 地址如果某位是网络地址，则子网掩码为 1，否则为 0。

### 为什么要使用子网掩码

两台主机要通信，首先要判断是否处于同一网段，即网络地址是否相同。如果相同，那么可以把数据包直接发送到目标主机，否则就需要路由网关将数据包转发送到目的地。

### 子网掩码和 IP 地址的关系

子网掩码是用来判断任意两台主机的 IP 地址是否属于同一网络的依据。拿双方主机的 IP 地址和自己主机的子网掩码做与运算，如结果为同一网络，就可以直接通信。

### 如何根据 IP 地址和子网掩码计算网络地址

1. 将 IP 地址与子网掩码转换成二进制数。
2. 将二进制形式的 IP 地址与子网掩码做与运算。
3. 将得出的结果转化为十进制，便得到网络地址。

### 网关

计算机的网关（Gateway）就是到其他网段的出口，也就是路由器接口 IP 地址。

路由器接口使用的 IP 地址可以是本网段中任何一个地址，不过通常使用该网段的第一个可用的地址或最后一个可用的地址，这是为了尽可能避免和本网段中的主机地址冲突。

网关实质上是一个网络通向其他网络的 IP 地址。

比如有网络 A 和网络 B，网络 A 的 IP 地址范围为 192.168.1.1~192. 168.1.254，子网掩码为 255.255.255.0。

网络 B 的 IP 地址范围为 192.168.2.1~192.168.2.254，子网掩码为 255.255.255.0。

在没有路由器的情况下，两个网络之间是不能进行 TCP / IP 通信的，即使是两个网络连接在同一台交换机 (或集线器) 上，TCP / IP 协议也会根据子网掩码 (255.255.255.0)
判定两个网络中的主机处在不同的网络里。

而要实现这两个网络之间的通信，则必须通过网关。

如果网络 A 中的主机发现数据包的目的主机不在本地网络中，就把数据包转发给它自己的网关，再由网关转发给网络 B 的网关，网络 B 的网关再转发给网络 B 的某个主机。网络 B 向网络 A
转发数据包的过程。

所以说，只有设置好网关的 IP 地址，TCP / IP 协议才能实现不同网络之间的相互通信。

### ping 命令用到的协议

ping 是我们测试网络连接的常用指令，它利用 **ICMP** 报文检测网络连接。

### DNS

- DNS 通过主机名，最终得到该主机名对应的 IP 地址的过程叫做域名解析（或主机名解析）。
- 我们更习惯于记住一个网站的名字，www.xxx.com，而不是记住它的 ip 地址，比如：167.23.10.2。

### DNS 工作原理

将主机域名转换为 ip 地址，属于应用层协议，使用 UDP 传输。

1. 客户端向本地 DNS 服务器发送解析请求。
2. 本地 DNS 如有相应记录会直接返回结果给客户端，如没有就向 DNS 根服务器发送请求。
3. DSN 根服务器接收到请求，返回给本地服务器一个所查询域的主域名服务器的地址。
4. 本地 dns 服务器再向返回的主域名服务器地址发送查询请求。
5. 主域名服务器如有记录就返回结果，没有的话返回相关的下级域名服务器地址。
6. 本地 DNS 服务器继续向接收到的地址进行查询请求。
7. 下级域名服务器有相应记录，返回结果。
8. 本地 dns 服务器将收到的返回地址发给客户端，同时写入自己的缓存，以便下次查询。

DNS 域名查询实际上就是个不断递归查询的过程，直到查找到相应结果，需要注意的时，当找不到相应记录，会返回空结果，而不是超时信息。

### 数据链路层是如何将 IP 地址转换为 MAC 地址的

通过 ARP 协议进行转换。

### ARP 协议 / 地址解析协议 / Address Resolution Protocol

一个通过解析网络层地址来找寻数据链路层地址的网络传输协议。用于实现从 IP 地址到 MAC 地址的映射，即询问目标 IP 对应的 MAC 地址。

### ICMP

### 目的地址

---

## 提高部分

---

### ping 的过程，假设 A ping B

ping 通知系统建立一个固定格式的 ICMP 请求数据包。

ICMP 协议打包这个数据包和 B 的 IP 地址转交给 IP 协议层。

IP 层协议将机器 B 的 IP 地址为目的地址，本机的 IP 地址为源地址，加上一些头部必要的控制信息，构建一个 IP 数据包。

获取 B 的 MAC 地址，做这个操作首先机器 A 会判断 B 是否在同一网段内，若 IP 层协议通过 B 的 IP 地址和自己的子网掩码，发现它跟自己属于同一网络，就直接在本网络查找这台机器的
MAC，否则则通过路由器进行类似查找

- 接下来是 **ARP 协议根据 IP 地址查找 MAC 地址**的过程:
    - 若两台机器之前有过通信，在机器 A 的 ARP 缓存表里应该存有 B 的 IP 与其 MAC 地址的映射关系
    - 若没有，则通过发送 ARP 请求广播，得到回应的 B 机器 MAC 地址，并交给数据链路层

数据链路层构建一个数据帧，目的地址是 IP 层传过来的 MAC 地址，源地址是本机的 MAC 地址，再附加一些必要的控制信息，依据以太网的介质访问规则将他们传送出去。

机器 B 收到这个数据帧后，先检查目的地址，和本机 MAC 地址对比：

- 符合，接受，接收后检查该数据帧，将 IP 数据包从帧中提取出来，交给本机的的 IP 地址协议层协议，IP 协议层检查之后，将有用的信息提取给 ICMP 协议，后者处理，马上构建一个 ICMP
  应答包，发送给 A，其过程和主机 A 发送 ICMP 请求包到 B 的过程类似，但不用 ARP 广播收取 A 的信息，因为请求包中已经有足够的信息用于 B 回应 A
- 若不符合，丢弃

可以知道 ping 的过程即一段发送报文和接受确认报文的过程，在来回直接可以计算时延。

### ARP 协议的工作过程

首先，每个主机都会有自己的 ARP 缓存区中建立一个 ARP 列表，以表示 IP 地址和 MAC 地址之间的对应关系。

当源主机要发送数据时，首先检测 ARP 列表中是否对应 IP 地址的目的主机的 MAC 地址。

- 如果有，则直接发送数据。
- 如果没有，就向本网段的所有主机发送 ARP 数据包。

当本网络的所有主机收到该 ARP 数据包时，首先检查数据包中的 IP 地址是否是自己的 IP 地址。

- 如果不是，则忽略该数据包。
- 如果是，则首先从数据包中取出源主机的 IP 和 MAC 地址写入到 ARP 列表中，如果存在，则覆盖然后将自己的 MAC 地址写入 ARP 响应包中，告诉源主机自己是它想要找的 MAC 地址。

源主机收到 ARP 响应包后，将目的主机的 IP 和 MAC 地址写入 ARP 列表，并利用此信息发送数据，如果源主机一直没有收到 ARP 响应数据包，表示 ARP 查询失败。

---










---

参考链接：

- [OSI 模型](https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B)
- [计算机网络常用知识总结](https://mp.weixin.qq.com/s?__biz=MzUyOTg1OTkyMA==&mid=2247486942&idx=1&sn=547fc2f0586a0e5e0003549afc50022e)

---













